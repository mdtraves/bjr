<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bramley</title>
    <style>
        input{
            width: 50px;
        }

        #fixtureList p{
            width: 100px;
            display: block;
            margin: 0 3px;
        }

        #fixtureList div{
            display: flex;
            
        }
        #fixtureList .time{
            width: 40px
        }
    </style>
</head>
<body>

    <h3>Add Game</h3>
    <input type="number" name="gameNumber" id="gameNumber" placeholder="Game Number">
    <input type="text" name="homeTeam" id="homeTeam" placeholder="Home Team">
    <input type="text" name="awayTeam" id="awayTeam" placeholder="Away Team">
    <input type="submit" value="submit" id="submit">

    <h3>Fixtures</h3>
    <div id="fixtureList" style="margin-bottom: 20px; display: flex; flex-direction: column;">

    </div>


    <div class="flex justify-center mt-2">
        <table id="friends-league" class="rounded shadow-lg"></table>
    <div>


    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js'
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-analytics.js'
    import { getDatabase, set, ref, onValue, child, push, update } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js"

    const firebaseConfig = {
        apiKey: "AIzaSyDnOvUmGiN8txOjKQ9DFG0g8V_2xUIOL6c",
        authDomain: "bramleyjr2023.firebaseapp.com",
        databaseURL: "https://bramleyjr2023-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "bramleyjr2023",
        storageBucket: "bramleyjr2023.appspot.com",
        messagingSenderId: "530663509573",
        appId: "1:530663509573:web:f3b418b649b3e63c835d2c",
        measurementId: "G-M2VZQW35D2"
    };

    const app = initializeApp(firebaseConfig);


    // DISPLAY FIXTURES //
    const db = getDatabase();
        let fixtureList = document.getElementById('fixtureList')
        const matchesDB = ref(db, 'matches/');
        onValue(matchesDB, (snapshot) => {
        const data = snapshot.val();
        fixtureList.innerHTML = ''

        for (var i = 1; i < data.length; i++) {
            
            // console.log("i : ",i);
            // console.log("data :", data);
            const span = document.createElement("span");
            span.innerHTML = `<div><p class="time">${data[i].time}</p><p>${data[i].homeTeam}</p><input class="goals" h_a="H" gameNo="${i}" type="number" value="${data[i].homeGoals}" /><input type="number" class="goals" h_a="A" gameNo="${i}"  value="${data[i].awayGoals}" /><p>${data[i].awayTeam}</p></div>`
            // console.log(data[i]);
            if(data[i]){
                fixtureList.append(span);
            }

        }
    });

    // ADD GAME //
    document.getElementById ("submit").addEventListener ("click",  function (){
        const db = getDatabase();
        let gameNumber = document.getElementById('gameNumber').value
        let homeTeam = document.getElementById('homeTeam').value
        let awayTeam = document.getElementById('awayTeam').value
        // console.log(gameNumber)
        set(ref(db, `matches/${gameNumber}/`), {
            homeTeam : homeTeam,
            awayTeam : awayTeam,
            homeGoals : 0,
            awayGoals : 0,
            time : "12:00"
        });
    } );

    // GOAL SCORED //
    document.body.addEventListener( 'change', function ( event ) {
      
        const db = getDatabase();
        var h_a = event.target.attributes.h_a.value
        var gameno = event.target.attributes.gameno.value
        var score = event.target.value
        console.log(h_a)
        console.log(gameno)
        console.log(score)
        const updates = {};

        if(h_a == 'H'){
            console.log('game ' + gameno + ': home team scored ' + score)
            update(ref(db, '/matches/' + gameno), { 'homeGoals':score })
            .then(() => {
                console.log('updated')
            })
            .catch((error) => console.log(error));
        }
        if(h_a == 'A'){
            console.log('game ' + gameno + ': away team scored ' + score)
            update(ref(db, '/matches/' + gameno), { 'awayGoals':score })
            .then(() => {
                console.log('updated')
            })
            .catch((error) => console.log(error));
        }
        
    } );




 

    
    
  

   
    let matches = [
        { home: "Reds", away: "Blues", result: "1-1" },
        { home: "Yellows", away: "Whites", result: "2-3" },
        { home: "Oranges", away: "Reds", result: "0-0" },
        { home: "Blues", away: "Yellows", result: "2-0" },
        { home: "Whites", away: "Oranges", result: "1-0" },
        { home: "Reds", away: "Yellows", result: "1-1" },
        { home: "Whites", away: "Blues", result: "3-3" },
        { home: "Oranges", away: "Yellows", result: "1-0" },
        { home: "Reds", away: "Whites", result: "1-2" },
        { home: "Oranges", away: "Blues", result: "3-1" },
    ]

let data = [];

function getDataFromMatches(matches) {    
  matches.forEach((match) => {
    let homeTeam = match.home;
    let awayTeam = match.away;
    let homeGoals = match.result.split("-")[0];
    let awayGoals = match.result.split("-")[1];
    let index = data.findIndex(team => team.NAME === homeTeam);
    // Home team non-existant in array, let's create it with default scores
    if (index === -1) {
      data.push({NAME: homeTeam, PL: 0, W: 0, D: 0, L: 0, GF: 0, GA: 0, GD: 0, P: 0});
    }
    index = data.findIndex(team => team.NAME === awayTeam);
    // Away team non-existant in array, let's create it with default scores
    if (index === -1) {
      data.push({NAME: awayTeam, PL: 0, W: 0, D: 0, L: 0, GF: 0, GA: 0, GD: 0, P: 0});
    }
    // parseInt is neccesary because goals are strings at this point
    processMatchResult(data, homeTeam, awayTeam, parseInt(homeGoals, 10), parseInt(awayGoals, 10));
  });
  // data is filled, let's sort it by points, goal difference, goals for.
  data.sort((teamA,teamB)=>(teamA.P - teamB.P || teamA.GD - teamB.GD || teamA.GF - teamB.GF));
  // sort gets ascending order, we need to reverse it for a normal league table
  data.reverse();
}

function processMatchResult(data, homeTeam, awayTeam, homeGoals, awayGoals) {
  // We get the reference to each team object
  let indexHT = data.findIndex(team => team.NAME === homeTeam);
  let indexAT = data.findIndex(team => team.NAME === awayTeam);
  // Common data (home) - plus one played and registering the goals
  data[indexHT].PL += 1;
  data[indexHT].GF += homeGoals;
  data[indexHT].GA += awayGoals;
  data[indexHT].GD = data[indexHT].GF - data[indexHT].GA;
  // Common data (away) - plus one played and registering the goals
  data[indexAT].PL += 1;
  data[indexAT].GF += awayGoals;
  data[indexAT].GA += homeGoals;
  data[indexAT].GD = data[indexAT].GF - data[indexAT].GA;
  // Draw
  if (homeGoals === awayGoals) {
    // Home team register a draw
    data[indexHT].D += 1;
    data[indexHT].P += 1;
    // Away team register a draw
    data[indexAT].D += 1;
    data[indexAT].P += 1;
  }
  // Home win
  if (homeGoals > awayGoals) {
    // Home team register a win
    data[indexHT].W += 1;
    data[indexHT].P += 3;
    // Away team register a loss
    data[indexAT].L += 1;
  }
  // Away win
  if (homeGoals < awayGoals) {
    // Away team register a win
    data[indexAT].W += 1;
    data[indexAT].P += 3;
    // Home team register a loss
    data[indexHT].L += 1;
  }
}

function insertTableHead(table, data) {
  let head = Object.keys(data[0]);
  let thead = table.createTHead();
  let row = thead.insertRow();
  row.className = "text-xs bg-purple-600 text-white font-bold";
  for (let key of head) {
    let th = document.createElement("th");
    th.className = "px-6 py-2";
    let text = document.createTextNode(key);
    th.appendChild(text);
    row.appendChild(th);
  }
}

function insertTableBody(table, data) {
  let oddRow = true;
  let first = true;
  for (let team of data) {
    let row = table.insertRow();
    // Zebra stripe
    if (oddRow) {
      row.className = "bg-purple-100";
      oddRow = false;
    } else {
      row.className = "bg-purple-50";
      oddRow = true;
    }
    if (first) {
      row.className = "font-semibold bg-purple-100";
      first = false;
    }

    for (let key in team) {
      let cell = row.insertCell();
      cell.className = "text-center p-2 border border-purple-50";
      let text = document.createTextNode(team[key]);
      cell.appendChild(text);
    }
  }
}

getDataFromMatches(matches);
let table = document.querySelector("#friends-league");
insertTableBody(table, data);
insertTableHead(table, data);



  </script>
</body>
</html>